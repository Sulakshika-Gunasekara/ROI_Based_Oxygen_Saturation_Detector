<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SpO2 Demo</title>
    <style>
      :root {
        --bg: #0b1220;
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --muted2: rgba(255, 255, 255, 0.5);
        --danger: #ef4444;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 16px;
        --accent1: #22c55e;
        --accent2: #38bdf8;
        --line: rgba(255, 255, 255, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
        background: radial-gradient(
            1200px 600px at 20% 10%,
            rgba(34, 197, 94, 0.12),
            transparent 60%
          ),
          radial-gradient(
            900px 500px at 85% 20%,
            rgba(56, 189, 248, 0.1),
            transparent 55%
          ),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 22px;
      }

      .app {
        width: min(1040px, 100%);
        position: relative;
      }

      .glass {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.08),
          rgba(255, 255, 255, 0.03)
        );
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: var(--shadow);
        border-radius: var(--radius);
        overflow: hidden;
      }

      header {
        padding: 22px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--line);
      }
      header h1 {
        font-size: 16px;
        margin: 0;
        letter-spacing: 0.6px;
        font-weight: 650;
      }

      header .pill {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 7px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent1);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
      }

      .pages {
        position: relative;
        height: 620px;
      }
      .page {
        position: absolute;
        inset: 0;
        padding: 26px;
        display: none;
        animation: fadeIn 240ms ease-out;
      }
      .page.active {
        display: block;
      }
      .page.left {
        transform: translateX(-20px);
        opacity: 0.2;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0px);
        }
      }

      .grid {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 16px;
        height: 100%;
      }

      .card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: var(--radius);
        padding: 18px;
      }
      .card h2 {
        margin: 0 0 10px 0;
        font-size: 15px;
      }
      .card p {
        margin: 0;
        color: var(--muted);
        line-height: 1.55;
        font-size: 13px;
      }

      .btn {
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 650;
        transition: 120ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.11);
      }
      .btn.primary {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.28),
          rgba(56, 189, 248, 0.18)
        );
        border-color: rgba(34, 197, 94, 0.35);
      }
      .btn.ghost {
        background: transparent;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .danger {
        color: #ffb4b4;
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(239, 68, 68, 0.25);
        padding: 10px 12px;
        border-radius: 12px;
        white-space: pre-wrap;
      }

      .uploader {
        margin-top: 14px;
        padding: 16px;
        border-radius: var(--radius);
        border: 1px dashed rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.04);
      }

      input[type="file"] {
        width: 100%;
        padding: 10px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        color: var(--text);
      }
      input[type="number"] {
        width: 110px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        color: var(--text);
      }
      label {
        font-size: 12px;
        color: var(--muted);
      }

      .progressWrap {
        margin-top: 14px;
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.12);
        height: 12px;
        background: rgba(255, 255, 255, 0.05);
      }
      .progressBar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent1), var(--accent2));
        transition: width 240ms ease;
      }
      .progressText {
        margin-top: 10px;
        color: var(--muted);
        font-size: 13px;
      }

      .spo2 {
        font-size: 64px;
        margin: 8px 0 0 0;
        letter-spacing: -1.6px;
        font-weight: 800;
      }
      .spo2 small {
        font-size: 18px;
        color: var(--muted);
        font-weight: 700;
      }

      canvas {
        width: 100%;
        height: 170px;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.22);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .previewImg {
        margin-top: 12px;
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.22);
      }

      .footerNote {
        margin-top: 12px;
        color: var(--muted2);
        font-size: 12px;
        line-height: 1.4;
      }
    </style>
  </head>

  <body>
    <div class="app glass">
      <header>
        <h1>Non-contact SpO₂ Estimation (Demo)</h1>
        <div class="pill">
          <span class="dot"></span>
          <span id="pillText">Checking backend…</span>
        </div>
      </header>

      <div class="pages">
        <!-- LANDING -->
        <section class="page active" id="page-landing">
          <div class="grid">
            <div class="card">
              <h2>Welcome</h2>
              <p>
                This demo estimates SpO₂ from facial video. Upload or analyze
                live (DroidCam).
              </p>
              <div class="row" style="margin-top: 16px">
                <button class="btn primary" id="goUpload">Start</button>
              </div>
            </div>

            <div class="card">
              <h2>Status</h2>
              <p id="healthText">Loading…</p>
              <div class="row" style="margin-top: 14px">
                <button class="btn" id="recheck">Re-check</button>
              </div>
              <div class="footerNote" id="healthNote"></div>
            </div>
          </div>
        </section>

        <!-- UPLOAD -->
        <section class="page" id="page-upload">
          <div class="grid">
            <div class="card">
              <h2>Upload a Video</h2>
              <p>Select a short face video (good lighting) and analyze.</p>

              <div class="uploader">
                <input type="file" id="fileInput" accept="video/*" />
                <div class="row" style="margin-top: 12px">
                  <button class="btn primary" id="analyzeBtn">
                    Analyze Upload
                  </button>
                  <button class="btn ghost" id="backBtn">Back</button>
                </div>
              </div>

              <div
                id="uploadErr"
                class="danger"
                style="display: none; margin-top: 12px"></div>
            </div>

            <div class="card">
              <h2>Live Camera (DroidCam)</h2>
              <p>
                This uses the desktop webcam device. DroidCam appears as a
                virtual webcam.
              </p>

              <div style="margin-top: 12px">
                <div class="row">
                  <div>
                    <label>Camera index</label><br />
                    <input
                      type="number"
                      id="camIndex"
                      value="0"
                      min="0"
                      step="1" />
                  </div>
                  <div>
                    <label>Duration (seconds)</label><br />
                    <input
                      type="number"
                      id="liveDuration"
                      value="5"
                      min="2"
                      step="1" />
                  </div>
                </div>

                <div class="row" style="margin-top: 12px">
                  <button class="btn primary" id="liveBtn">Analyze Live</button>
                  <button class="btn" id="listCamsBtn">List Cameras</button>
                </div>

                <div
                  id="camList"
                  class="footerNote"
                  style="margin-top: 10px"></div>
                <div
                  id="liveErr"
                  class="danger"
                  style="display: none; margin-top: 12px"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- PROCESSING -->
        <section class="page" id="page-processing">
          <div class="grid">
            <div class="card">
              <h2>Processing</h2>
              <p>Uploading / capturing and estimating SpO₂…</p>

              <div class="progressWrap">
                <div class="progressBar" id="progressBar"></div>
              </div>
              <div class="progressText" id="progressText">Starting…</div>

              <div
                id="procErr"
                class="danger"
                style="display: none; margin-top: 12px"></div>

              <div class="row" style="margin-top: 14px">
                <button class="btn ghost" id="cancelBtn">Cancel</button>
              </div>
            </div>

            <div class="card">
              <h2>Live Preview + rPPG</h2>
              <p class="muted">
                Live video preview from DroidCam while processing.
              </p>

              <canvas id="liveCanvas" width="900" height="240"></canvas>
              <img
                id="livePreview"
                class="previewImg"
                style="display: none"
                alt="Live camera preview" />

              <div class="footerNote">
                If you see your phone camera here, you are 100% using DroidCam.
              </div>
            </div>
          </div>
        </section>

        <!-- RESULTS -->
        <section class="page" id="page-results">
          <div class="grid">
            <div class="card">
              <h2>Result</h2>
              <p class="muted">Estimated SpO₂</p>
              <div class="spo2">
                <span id="spo2Value">–</span> <small>%</small>
              </div>
              <p id="resultMeta" class="muted" style="margin-top: 10px"></p>

              <div class="row" style="margin-top: 16px">
                <button class="btn primary" id="newBtn">New Analysis</button>
                <button class="btn ghost" id="homeBtn">Home</button>
              </div>
            </div>

            <div class="card">
              <h2>rPPG signal</h2>
              <p class="muted">Filtered green-channel signal (demo).</p>
              <canvas id="finalCanvas" width="900" height="240"></canvas>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      const BACKEND = "http://localhost:8001";

      const pages = ["landing", "upload", "processing", "results"];
      function showPage(name) {
        for (const p of pages) {
          const el = document.getElementById("page-" + p);
          el.classList.remove("active", "left");
        }
        for (const p of pages) {
          const el = document.getElementById("page-" + p);
          if (p === name) {
            el.classList.add("active");
            break;
          } else {
            el.classList.add("left");
          }
        }
      }

      function setProgress(pct, text) {
        document.getElementById("progressBar").style.width = pct + "%";
        document.getElementById("progressText").textContent = text;
      }

      function setTopPill(text) {
        document.getElementById("pillText").textContent = text;
      }

      const liveCanvas = document.getElementById("liveCanvas");
      const finalCanvas = document.getElementById("finalCanvas");
      const liveCtx = liveCanvas.getContext("2d");
      const finalCtx = finalCanvas.getContext("2d");

      function clearPlot(ctx, canvas) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      function drawWave(ctx, canvas, arr) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "rgba(0,0,0,0.22)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (!arr || arr.length < 2) return;

        const W = canvas.width;
        const H = canvas.height;

        let min = Infinity,
          max = -Infinity;
        for (const v of arr) {
          if (v < min) min = v;
          if (v > max) max = v;
        }
        const range = max - min || 1;

        ctx.beginPath();
        for (let i = 0; i < arr.length; i++) {
          const x = (i / (arr.length - 1)) * (W - 20) + 10;
          const y = H - 10 - ((arr[i] - min) / range) * (H - 20);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.lineWidth = 2;
        ctx.strokeStyle = "rgba(56,189,248,0.9)";
        ctx.stroke();
      }

      const healthText = document.getElementById("healthText");
      const healthNote = document.getElementById("healthNote");
      const uploadErr = document.getElementById("uploadErr");
      const liveErr = document.getElementById("liveErr");
      const procErr = document.getElementById("procErr");
      const spo2El = document.getElementById("spo2Value");
      const resultMeta = document.getElementById("resultMeta");

      let abortCtrl = null;
      let animTimer = null;

      function fmt(n) {
        if (n === undefined || n === null) return "–";
        return Number(n).toFixed(3);
      }

      // ---- Live MJPEG preview controls ----
      function startLivePreview(camIndex) {
        const img = document.getElementById("livePreview");
        img.style.display = "block";
        img.src = `${BACKEND}/mjpeg?cam=${camIndex}`;
      }

      function stopLivePreview() {
        const img = document.getElementById("livePreview");
        img.style.display = "none";
        img.src = "";
      }

      async function checkHealth() {
        try {
          const r = await fetch(BACKEND + "/health");
          const out = await r.json();
          if (!out.ok) throw new Error("Backend not ok");

          const gpu = out.gpu_name ? out.gpu_name : out.cuda ? "CUDA" : "CPU";
          const ram = fmt(out.ram_gb);
          const vramA = fmt(out.gpu_mem_allocated_gb);
          const vramR = fmt(out.gpu_mem_reserved_gb);

          healthText.textContent = `OK • ${gpu} • RAM=${ram} GB • VRAM alloc=${vramA} GB • VRAM res=${vramR} GB`;
          healthNote.textContent = `max_t=${out.max_t} • n_feats=${out.n_feats}`;

          setTopPill(`Backend OK • RAM ${ram} GB`);
        } catch (e) {
          healthText.textContent =
            "Backend not reachable. Start backend.py on port 8001.";
          healthNote.textContent = "";
          setTopPill("Backend error");
        }
      }

      async function analyzeUpload() {
        stopLivePreview();
        uploadErr.style.display = "none";
        procErr.style.display = "none";

        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          uploadErr.style.display = "block";
          uploadErr.textContent = "Please select a video file first.";
          return;
        }

        showPage("processing");
        setProgress(3, "Starting…");
        abortCtrl = new AbortController();

        let wave = [];
        let t = 0;
        animTimer = setInterval(() => {
          t += 1;
          wave.push(Math.sin(t / 6) * 0.8 + (Math.random() - 0.5) * 0.25);
          if (wave.length > 180) wave.shift();
          drawWave(liveCtx, liveCanvas, wave);
        }, 80);

        try {
          setProgress(12, "Uploading video…");
          const form = new FormData();
          form.append("file", file);

          const resp = await fetch(BACKEND + "/analyze_video", {
            method: "POST",
            body: form,
            signal: abortCtrl.signal,
          });

          const out = await resp.json();
          if (out.error) throw new Error(out.error);

          clearInterval(animTimer);
          animTimer = null;

          setProgress(100, "Done.");
          spo2El.textContent = Number(out.spo2).toFixed(1);

          const gpu = out.gpu_name || (out.cuda ? "CUDA" : "CPU");
          resultMeta.textContent = `Upload • GPU: ${gpu} • RAM ${fmt(
            out.ram_gb
          )} GB • VRAM alloc ${fmt(out.gpu_mem_allocated_gb)} GB (res ${fmt(
            out.gpu_mem_reserved_gb
          )} GB)`;

          drawWave(finalCtx, finalCanvas, out.rppg || []);
          showPage("results");
          checkHealth();
        } catch (e) {
          clearInterval(animTimer);
          animTimer = null;
          setProgress(0, "Failed.");
          procErr.style.display = "block";
          procErr.textContent =
            "Upload processing failed.\n\nError: " + e.message;
          checkHealth();
        }
      }

      async function analyzeLive() {
        const cam = Number(document.getElementById("camIndex").value || 0);
        const duration = Number(
          document.getElementById("liveDuration").value || 5
        );

        liveErr.style.display = "none";
        procErr.style.display = "none";

        showPage("processing");
        setProgress(5, "Capturing live video…");
        abortCtrl = new AbortController();

        // Start live MJPEG preview (this is the proof of DroidCam usage)
        startLivePreview(cam);

        let wave = [];
        let t = 0;
        animTimer = setInterval(() => {
          t += 1;
          wave.push(Math.sin(t / 6) * 0.8 + (Math.random() - 0.5) * 0.25);
          if (wave.length > 180) wave.shift();
          drawWave(liveCtx, liveCanvas, wave);
        }, 80);

        try {
          const resp = await fetch(
            `${BACKEND}/analyze_live?cam=${cam}&duration=${duration}`,
            {
              signal: abortCtrl.signal,
            }
          );
          const out = await resp.json();
          if (out.error) throw new Error(out.error);

          clearInterval(animTimer);
          animTimer = null;
          stopLivePreview();

          setProgress(100, "Done.");
          spo2El.textContent = Number(out.spo2).toFixed(1);

          const gpu = out.gpu_name || (out.cuda ? "CUDA" : "CPU");
          resultMeta.textContent = `Live • Cam ${out.cam_index} • ${
            out.duration
          }s • GPU: ${gpu} • RAM ${fmt(out.ram_gb)} GB • VRAM alloc ${fmt(
            out.gpu_mem_allocated_gb
          )} GB (res ${fmt(out.gpu_mem_reserved_gb)} GB)`;

          drawWave(finalCtx, finalCanvas, out.rppg || []);
          showPage("results");
          checkHealth();
        } catch (e) {
          clearInterval(animTimer);
          animTimer = null;
          stopLivePreview();

          setProgress(0, "Failed.");
          procErr.style.display = "block";
          procErr.textContent =
            "Live processing failed.\n\nError: " + e.message;
          checkHealth();
        }
      }

      async function listCameras() {
        liveErr.style.display = "none";
        const camList = document.getElementById("camList");
        camList.textContent = "Checking cameras…";
        try {
          const r = await fetch(BACKEND + "/list_cameras?max_index=10");
          const out = await r.json();
          camList.textContent = `Available camera indices: ${JSON.stringify(
            out.cameras || []
          )}`;
          checkHealth();
        } catch (e) {
          camList.textContent = "Failed to list cameras. Is backend running?";
        }
      }

      // Buttons
      document.getElementById("goUpload").onclick = () => showPage("upload");
      document.getElementById("backBtn").onclick = () => {
        stopLivePreview();
        showPage("landing");
      };
      document.getElementById("homeBtn").onclick = () => {
        stopLivePreview();
        showPage("landing");
      };
      document.getElementById("newBtn").onclick = () => {
        stopLivePreview();
        showPage("upload");
      };

      document.getElementById("recheck").onclick = checkHealth;
      document.getElementById("analyzeBtn").onclick = analyzeUpload;
      document.getElementById("liveBtn").onclick = analyzeLive;
      document.getElementById("listCamsBtn").onclick = listCameras;

      document.getElementById("cancelBtn").onclick = () => {
        if (abortCtrl) abortCtrl.abort();
        abortCtrl = null;
        if (animTimer) clearInterval(animTimer);
        animTimer = null;
        stopLivePreview();
        showPage("upload");
      };

      // Boot
      checkHealth();
      clearPlot(liveCtx, liveCanvas);
      clearPlot(finalCtx, finalCanvas);
    </script>
  </body>
</html>
